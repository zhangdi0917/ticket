package com.jess.ticket.ui.activity;import com.jess.ticket.R;import com.jess.ticket.app.TicketApplication;import com.jess.ticket.sns.WechatManager;import com.jess.ticket.sns.WeiboKeeper;import com.jess.ticket.ui.adapter.MenuAdapter;import com.jess.ticket.ui.fragment.BaseFragment;import com.jess.ticket.ui.fragment.MyTicketFragment;import com.jess.ticket.ui.fragment.NearbyFragment;import com.jess.ticket.ui.fragment.SettingFragment;import com.jess.ticket.ui.fragment.ShareFragment;import com.jesskit.android.validate.Validate;import com.nostra13.universalimageloader.core.DisplayImageOptions;import com.nostra13.universalimageloader.core.ImageLoader;import com.sina.weibo.sdk.auth.Oauth2AccessToken;import android.os.Bundle;import android.app.Activity;import android.app.FragmentManager;import android.app.FragmentTransaction;import android.content.res.Configuration;import android.support.v4.app.ActionBarDrawerToggle;import android.support.v4.view.GravityCompat;import android.support.v4.widget.DrawerLayout;import android.view.LayoutInflater;import android.view.MenuItem;import android.view.View;import android.widget.AdapterView;import android.widget.ImageView;import android.widget.ListView;import android.widget.TextView;public class MainActivity extends BaseActivity {    private DrawerLayout mDrawerLayout;    private CustomActionBarDrawerToggle mDrawerToggle;    private View mMenuHeader;    private ImageView mWeiboAvatarIv;    private TextView mWeiboNameTv;    private ListView mMenuListView;    private MenuAdapter mMenuAdapter = null;    private int[] mMenuRes = { R.string.drawer_menu_nearby, R.string.drawer_menu_my, R.string.drawer_menu_share,            R.string.drawer_menu_setting };    private static final String BUNDLE_CURRENT_FRAGMENT_ID = "BUNDLE_CURRENT_FRAGMENT_ID_id";    private int mCurrentFragmentId;    private BaseFragment mCurrentFragment;    private DisplayImageOptions mOptions;    @Override    public void onCreate(Bundle savedInstanceState) {        super.onCreate(savedInstanceState);        setContentView(R.layout.activity_main);        mDrawerLayout = (DrawerLayout) findViewById(R.id.drawer_layout);        mDrawerLayout.setDrawerShadow(R.drawable.drawer_shadow, GravityCompat.START);        mDrawerToggle = new CustomActionBarDrawerToggle(this, mDrawerLayout);        mDrawerLayout.setDrawerListener(mDrawerToggle);        initMenu();        updateMenuView();        if (savedInstanceState == null) {            mCurrentFragmentId = mMenuRes[0];        } else {            mCurrentFragmentId = savedInstanceState.getInt(BUNDLE_CURRENT_FRAGMENT_ID);        }        switchFragment(mCurrentFragmentId);        new Validate().validate(this);        WechatManager wechatManager = new WechatManager(this);        wechatManager.init();        mOptions = new DisplayImageOptions.Builder().cacheInMemory(true).cacheOnDisc(true)                .showImageForEmptyUri(R.drawable.weibo_avatar_empty).considerExifParams(true).build();    }    private void initMenu() {        mMenuHeader = LayoutInflater.from(this).inflate(R.layout.menu_header, null);        mWeiboAvatarIv = (ImageView) mMenuHeader.findViewById(R.id.menu_weibo_avatar);        mWeiboNameTv = (TextView) mMenuHeader.findViewById(R.id.menu_weibo_name);        mMenuListView = (ListView) findViewById(R.id.menu_listview);        mMenuAdapter = new MenuAdapter(getApplicationContext(), mMenuRes);        mMenuListView.addHeaderView(mMenuHeader);        mMenuListView.setAdapter(mMenuAdapter);        mMenuListView.setOnItemClickListener(mOnMenuItemClickListener);    }    private void updateMenuView() {        Oauth2AccessToken accessToken = WeiboKeeper.readAccessToken(this);        if (accessToken.isSessionValid()) {            if (mMenuListView.getHeaderViewsCount() == 0) {                mMenuListView.addHeaderView(mMenuHeader);                mMenuListView.setAdapter(mMenuAdapter);            }            String screenName = WeiboKeeper.readScreenName(this);            mWeiboNameTv.setText(screenName);            String avatar = WeiboKeeper.readAvatar(this);            ImageLoader.getInstance().displayImage(avatar, mWeiboAvatarIv, mOptions, null);        } else {            if (mMenuListView.getHeaderViewsCount() > 0) {                mMenuListView.removeHeaderView(mMenuHeader);                mMenuListView.setAdapter(mMenuAdapter);            }            ImageLoader.getInstance().displayImage(null, mWeiboAvatarIv, mOptions, null);            mWeiboNameTv.setText("");        }    }    private AdapterView.OnItemClickListener mOnMenuItemClickListener = new AdapterView.OnItemClickListener() {        @Override        public void onItemClick(AdapterView<?> arg0, View arg1, int arg2, long arg3) {            int pos = arg2 - mMenuListView.getHeaderViewsCount();            if (pos < 0 || pos > mMenuRes.length - 1) {                return;            }            if (mCurrentFragmentId != mMenuRes[pos]) {                mCurrentFragmentId = mMenuRes[pos];                switchFragment(mCurrentFragmentId);            }            mDrawerLayout.closeDrawers();        }    };    @Override    protected void onSaveInstanceState(Bundle outState) {        super.onSaveInstanceState(outState);        outState.putInt(BUNDLE_CURRENT_FRAGMENT_ID, mCurrentFragmentId);    }    @Override    protected void onPostCreate(Bundle savedInstanceState) {        super.onPostCreate(savedInstanceState);        mDrawerToggle.syncState();    }    @Override    public void onConfigurationChanged(Configuration newConfig) {        super.onConfigurationChanged(newConfig);        mDrawerToggle.onConfigurationChanged(newConfig);    }    @Override    public boolean onOptionsItemSelected(MenuItem item) {        if (mDrawerToggle.onOptionsItemSelected(item)) {            return true;        }        return super.onOptionsItemSelected(item);    }    @Override    public void onResume() {        super.onResume();        if (TicketApplication.getInstance().mBMapManager != null) {            TicketApplication.getInstance().mBMapManager.start();        }    }    @Override    public void onPause() {        super.onPause();        if (TicketApplication.getInstance().mBMapManager != null) {            TicketApplication.getInstance().mBMapManager.stop();        }    }    @Override    public void onDestroy() {        TicketApplication app = (TicketApplication) this.getApplication();        if (app.mBMapManager != null) {            app.mBMapManager.destroy();            app.mBMapManager = null;        }        super.onDestroy();        System.exit(0);    }    private class CustomActionBarDrawerToggle extends ActionBarDrawerToggle {        public CustomActionBarDrawerToggle(Activity mActivity, DrawerLayout mDrawerLayout) {            super(mActivity, mDrawerLayout, R.drawable.ic_drawer, R.string.app_name, R.string.app_name);        }        @Override        public void onDrawerClosed(View view) {            getActionBar().setTitle(mCurrentFragment.getTitleResourceId());            invalidateOptionsMenu(); // creates call to onPrepareOptionsMenu()            updateMenuView();        }        @Override        public void onDrawerOpened(View drawerView) {            getActionBar().setTitle(getString(R.string.app_name));            invalidateOptionsMenu(); // creates call to onPrepareOptionsMenu()            updateMenuView();        }    }    private void switchFragment(int id) {        FragmentManager fragmentManager = getFragmentManager();        FragmentTransaction fragmentTransaction = fragmentManager.beginTransaction();        mCurrentFragment = (BaseFragment) fragmentManager.findFragmentById(id);        if (mCurrentFragment == null) {            switch (id) {            case R.string.drawer_menu_nearby:                mCurrentFragment = new NearbyFragment();                break;            case R.string.drawer_menu_my:                mCurrentFragment = new MyTicketFragment();                break;            case R.string.drawer_menu_share:                mCurrentFragment = new ShareFragment();                break;            case R.string.drawer_menu_setting:                mCurrentFragment = new SettingFragment();                break;            }        }        fragmentTransaction.replace(R.id.fragment_main, mCurrentFragment);        fragmentTransaction.commit();    }    @Override    protected boolean needWeibo() {        return true;    }}